---
import Breadcrumbs from "../../components/content/Breadcrumbs.astro"
import NotePreview from "../../components/content/NotePreview.astro"
import SearchInput from "../../components/interactive/SearchInput.astro"
import Section from "../../components/ui/Section.astro"
import BaseLayout from "../../layouts/BaseLayout.astro"
import { getPreviewNotes } from "../../lib/content"

const notes = await getPreviewNotes()
const breadcrumbItems = [{ label: "Home", href: "/" }, { label: "Notes" }]
---

<BaseLayout
  title="Notes Archive"
  description="Browse through my collected thoughts and insights on various topics."
  mainClass="mx-auto w-full max-w-3xl pb-18 px-4 md:px-6"
>

    <Section title="Notes" count={notes.length}>
      <Breadcrumbs items={breadcrumbItems} class="mb-6" />

      <div class="flex flex-col space-y-2">
        <div class="flex flex-col pb-4">
          <SearchInput />
        </div>

        <section>
          <ul class="-mx-4" id="notes-list">
            {
              notes.map((note) => (
                <li>
                  <NotePreview note={note} />
                </li>
              ))
            }
          </ul>

          <div id="no-results" class="hidden text-center py-12 text-muted-foreground">
            No notes found matching your search.
          </div>
        </section>

        {
          notes.length > 0 && (
            <div class="text-muted-foreground pt-2 text-center text-sm" data-bottom-count>
              Showing {notes.length} notes
            </div>
          )
        }
      </div>
    </Section>
</BaseLayout>

<script is:inline>
  window.addEventListener('DOMContentLoaded', async () => {
    const searchInput = document.getElementById("search-input")
    const notesList = document.getElementById("notes-list")
    const noResults = document.getElementById("no-results")

    if (!searchInput || !notesList) return

    // Initialize Pagefind once at page load
    let pagefind
    try {
      pagefind = await import("/pagefind/pagefind.js")
      await pagefind.init()
    } catch (error) {
      console.error('Failed to load Pagefind:', error)
      return
    }

    const listItems = notesList.querySelectorAll("li")

    searchInput.addEventListener("input", async (e) => {
      const term = e.target.value.trim()

      if (term === "") {
        listItems.forEach((li) => { li.style.display = "" })
        if (noResults) noResults.classList.add("hidden")

        const countElement = document.querySelector('[data-count]')
        const bottomCount = document.querySelector('[data-bottom-count]')
        const totalCount = listItems.length
        if (countElement) countElement.textContent = totalCount.toString()
        if (bottomCount) bottomCount.textContent = `Showing ${totalCount} note${totalCount !== 1 ? 's' : ''}`
        return
      }

      try {
        const search = await pagefind.search(term)
        const results = await Promise.all(search.results.map(r => r.data()))

        const resultUrls = new Set(
          results.map((result) => {
            return result.url.replace(/\/index\.html$/, '').replace(/\/$/, '')
          })
        )

        let visibleCount = 0
        listItems.forEach((li) => {
          const link = li.querySelector("a")
          const url = link?.getAttribute("href") || ""
          const normalizedUrl = url.replace(/\/index\.html$/, '').replace(/\/$/, '')

          if (resultUrls.has(normalizedUrl)) {
            li.style.display = ""
            visibleCount++
          } else {
            li.style.display = "none"
          }
        })

        if (noResults) noResults.classList.toggle("hidden", visibleCount > 0)

        const countElement = document.querySelector('[data-count]')
        const bottomCount = document.querySelector('[data-bottom-count]')
        if (countElement) countElement.textContent = visibleCount.toString()
        if (bottomCount) bottomCount.textContent = `Showing ${visibleCount} note${visibleCount !== 1 ? 's' : ''}`
      } catch (error) {
        console.error('Pagefind search error:', error)
      }
    })
  })
</script>
