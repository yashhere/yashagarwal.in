---
import GithubSlugger from "github-slugger"

import Breadcrumbs from "../../components/content/Breadcrumbs.astro"
import NotePreview from "../../components/content/NotePreview.astro"
import Navigation from "../../components/layout/Navigation.astro"
import Section from "../../components/ui/Section.astro"
import BaseLayout from "../../layouts/BaseLayout.astro"
import { getPreviewNotes } from "../../lib/content"

export async function getStaticPaths() {
  const notes = await getPreviewNotes()
  const allTags = new Set<string>()

  notes.forEach((note) => {
    note.data.tags?.forEach((tag) => allTags.add(tag))
  })

  const slugger = new GithubSlugger()

  return Array.from(allTags).map((tag) => {
    const slug = slugger.slug(tag)
    return {
      params: { tag: slug },
      props: { tagName: tag },
    }
  })
}

const { tagName } = Astro.props
const { tag } = Astro.params

const allNotes = await getPreviewNotes()
const filteredNotes = allNotes.filter((note) =>
  note.data.tags?.some((t) => {
    const slugger = new GithubSlugger()
    return slugger.slug(t) === tag
  })
)

const breadcrumbItems = [
  { label: "Home", href: "/" },
  { label: "Tags", href: "/tags" },
  { label: tagName },
]
---

<BaseLayout title={`Tagged: ${tagName}`} description={`Notes tagged with ${tagName}`}>
  <main class="w-full max-w-3xl flex-1 pb-18 px-4 md:px-6">
    <Navigation />
    <Section title={tagName} count={filteredNotes.length}>
      <Breadcrumbs items={breadcrumbItems} class="mb-6" />

      <ul class="-mx-4 space-y-2">
        {
          filteredNotes.map((note) => (
            <li>
              <NotePreview note={note} />
            </li>
          ))
        }
      </ul>
    </Section>
  </main>
</BaseLayout>
