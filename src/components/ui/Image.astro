---
import { cn } from "../../lib/utils"
import { Icon } from 'astro-icon/components'

interface Props {
  src: string | ImageMetadata
  alt: string
  title?: string
  width?: number | string
  height?: number | string
  showSkeleton?: boolean
  expandable?: boolean
  class?: string
  imageClass?: string
}

const {
  src: propSrc,
  alt,
  title,
  width: propWidth,
  height: propHeight,
  showSkeleton = true,
  expandable = true,
  class: className,
  imageClass,
  ...rest
} = Astro.props

let src: string = ""
let width = propWidth
let height = propHeight

if (typeof propSrc === "object" && propSrc !== null && "src" in propSrc) {
  src = propSrc.src
  width = propWidth || propSrc.width
  height = propHeight || propSrc.height
} else if (typeof propSrc === "string") {
  src = propSrc
}
---

<figure
  class={cn("group my-6 w-full", className)}
  x-data={`{
    isLoading: true,
    hasError: false,
    isExpanded: false,
    init() {
      const img = this.$el.querySelector('img');
      if (img && img.complete) {
        this.isLoading = false;
      }
    },
    handleLoad() {
      this.isLoading = false;
    },
    handleError() {
      this.isLoading = false;
      this.hasError = true;
    },
    toggleExpand() {
      if (${expandable} && !this.hasError && !this.isLoading) {
        this.isExpanded = true;
        document.body.style.overflow = 'hidden';
      }
    },
    closeExpand() {
      this.isExpanded = false;
      document.body.style.overflow = '';
    }
  }`}
  @keydown.escape.window="if (isExpanded) closeExpand()"
>
  <div class="relative">
    <!-- Error fallback -->
    <div
      class="bg-muted/20 text-muted-foreground absolute inset-0 flex items-center justify-center rounded-md"
      x-show="hasError"
      x-cloak
    >
      <div class="text-center">
        <Icon name="lucide:image-off" class="mx-auto mb-2 h-6 w-6" />
        <p class="text-xs">Image unavailable</p>
      </div>
    </div>

    <!-- Main image -->
    <img
      src={src}
      alt={alt}
      width={width}
      height={height}
      loading="lazy"
      decoding="async"
      {...rest}
      class={cn(
        "w-full rounded-md transition-opacity duration-300",
        expandable && "cursor-zoom-in hover:brightness-110",
        imageClass
      )}
      x-bind:class="(isLoading || hasError) ? 'opacity-0' : 'opacity-100'"
      @load="handleLoad()"
      @error="handleError()"
      @click="toggleExpand()"
    />

    <!-- Expand icon hint -->
    {
      expandable && (
        <div
          class="absolute top-2 right-2 opacity-0 transition-opacity duration-200 group-hover:opacity-100"
          x-show="!isLoading && !hasError"
          x-cloak
        >
          <div class="rounded-md bg-black/50 p-1.5 text-white backdrop-blur-sm">
            <Icon name="lucide:zoom-in" class="h-4 w-4" />
          </div>
        </div>
      )
    }
  </div>

  <!-- Caption -->
  {
    title && (
      <figcaption class="mt-2 text-center" x-show="!hasError" x-cloak>
        <span class="text-muted-foreground/80 text-sm">{title}</span>
      </figcaption>
    )
  }

  <!-- Modal (inside figure to share Alpine context) -->
  <div
    class="bg-background/50 fixed inset-0 z-50 flex items-center justify-center p-4 backdrop-blur-sm"
    x-show="isExpanded"
    x-transition.opacity
    @click.self="closeExpand()"
    x-cloak
    style="display: none;"
  >
    <div class="relative" @click.stop>
      <!-- Expanded Image -->
      <img
        src={src}
        alt={alt}
        class="max-h-[85vh] max-w-[95vw] cursor-zoom-out rounded-md object-contain"
        @click="closeExpand()"
      />

      <!-- Close button -->
      <button
        @click="closeExpand()"
        class="bg-background/90 hover:bg-background text-foreground border-border absolute top-10 right-2 z-30 rounded-full border p-2 shadow-lg transition-colors"
        aria-label="Close expanded image"
      >
        <Icon name="lucide:x" class="h-5 w-5" />
      </button>

      <!-- Caption in modal -->
      {
        title && (
          <div class="absolute right-4 -bottom-12 left-4 p-3">
            <p class="text-center text-sm text-foreground">{title}</p>
          </div>
        )
      }
    </div>
  </div>
</figure>
